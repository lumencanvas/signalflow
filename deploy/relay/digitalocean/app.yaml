# DigitalOcean App Platform Specification
#
# Deploy with: doctl apps create --spec deploy/relay/digitalocean/app.yaml
#
# This uses the STANDALONE relay that pulls from crates.io.
# No monorepo context required.

name: clasp-relay

services:
  - name: relay
    dockerfile_path: Dockerfile
    source_dir: deploy/relay  # Standalone directory with its own Cargo.toml
    github:
      repo: lumencanvas/clasp
      branch: main
      deploy_on_push: true

    # WebSocket requires HTTP port
    http_port: 7330

    instance_count: 1
    instance_size_slug: basic-xxs  # $5/month, 512MB RAM

    # Route all traffic to this service
    routes:
      - path: /

    # Environment variables
    envs:
      - key: RUST_LOG
        value: info

    # Health check - WebSocket accepts HTTP upgrade
    health_check:
      http_path: /
      initial_delay_seconds: 30  # Rust compile takes time
      period_seconds: 30
      timeout_seconds: 5
      success_threshold: 1
      failure_threshold: 3

# Domain configuration (requires DNS setup)
# Uncomment and configure for production:
# domains:
#   - domain: relay.clasp.to
#     type: PRIMARY
